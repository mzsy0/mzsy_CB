"""
é‚¢ä¸è¡Œï½œç­–ç•¥åˆ†äº«ä¼š
è‚¡ç¥¨é‡åŒ–ç­–ç•¥æ¡†æ¶ğ“Ÿğ“»ğ“¸

ç‰ˆæƒæ‰€æœ‰ Â©ï¸ é‚¢ä¸è¡Œ
å¾®ä¿¡: xbx1717

æœ¬ä»£ç ä»…ä¾›ä¸ªäººå­¦ä¹ ä½¿ç”¨ï¼Œæœªç»æˆæƒä¸å¾—å¤åˆ¶ã€ä¿®æ”¹æˆ–ç”¨äºå•†ä¸šç”¨é€”ã€‚

Author: é‚¢ä¸è¡Œ
"""

import numba as nb
import numpy as np
from numba.experimental import jitclass

"""
# æ–°è¯­æ³•å°è®²å ‚
é€šè¿‡æ“ä½œå¯¹è±¡çš„å€¼è€Œä¸æ˜¯æ›´æ¢referenceï¼Œæ¥ä¿è¯æ‰€æœ‰å¼•ç”¨çš„ä½ç½®éƒ½èƒ½åŒæ­¥æ›´æ–°ã€‚

`self.target_lots[:] = target_lots`
è¿™ä¸ªå†™æ³•æ¶‰åŠ Python ä¸­çš„åˆ‡ç‰‡ï¼ˆsliceï¼‰æ“ä½œå’Œå¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚

`target_lots: nb.int64[:]  # ç›®æ ‡æŒä»“æ‰‹æ•°`ï¼Œself.target_lots æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œ`[:]` æ˜¯åˆ‡ç‰‡æ“ä½œç¬¦ï¼Œè¡¨ç¤ºå¯¹æ•´ä¸ªåˆ—è¡¨è¿›è¡Œåˆ‡ç‰‡ã€‚

>>>>>>>>>>>>>>>>>> 37ke <<<<<<<<<<<<<<<<<<<<<

### è¯¦ç»†è§£é‡Šï¼š

1. **`self.target_lots[:] = target_lots`**:
   - `self.target_lots` æ˜¯å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ˆæˆ–è€…å…¶å®ƒæ”¯æŒåˆ‡ç‰‡æ“ä½œçš„å¯å˜åºåˆ—ï¼‰ã€‚
   - `[:]` æ˜¯åˆ‡ç‰‡æ“ä½œç¬¦ï¼Œè¡¨ç¤ºå¯¹æ•´ä¸ªåˆ—è¡¨è¿›è¡Œåˆ‡ç‰‡ã€‚å…·ä½“æ¥è¯´ï¼Œ`[:]` æ˜¯å¯¹åˆ—è¡¨çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œé€‰æ‹©ï¼Œè¿™ç§å†™æ³•å¯ä»¥ç”¨äºå¤åˆ¶åˆ—è¡¨æˆ–å¯¹æ•´ä¸ªåˆ—è¡¨å†…å®¹è¿›è¡Œæ›¿æ¢ã€‚

2. **å…·ä½“æ“ä½œ**ï¼š
   - `self.target_lots[:] = target_lots` ä¸æ˜¯ç›´æ¥å°† `target_lots` èµ‹å€¼ç»™ `self.target_lots`ï¼Œè€Œæ˜¯å°† `target_lots` ä¸­çš„æ‰€æœ‰å…ƒç´ æ›¿æ¢ `self.target_lots` ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚
   - è¿™ç§åšæ³•çš„ä¸€ä¸ªå¥½å¤„æ˜¯ä¸ä¼šæ”¹å˜ `self.target_lots` å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œæ˜¯ä¿®æ”¹å®ƒçš„å†…å®¹ã€‚è¿™åœ¨æœ‰å…¶ä»–å¯¹è±¡å¼•ç”¨ `self.target_lots` æ—¶éå¸¸æœ‰ç”¨ï¼Œç¡®ä¿æ‰€æœ‰å¼•ç”¨è€…çœ‹åˆ°çš„åˆ—è¡¨å†…å®¹éƒ½è¢«æ›´æ–°ï¼Œè€Œä¸ä¼šå› ä¸ºé‡æ–°èµ‹å€¼è€Œæ”¹å˜åˆ—è¡¨çš„å¼•ç”¨ã€‚

### ä¸¾ä¸ªä¾‹å­ï¼š

```python
a = [1, 2, 3]
b = a
a[:] = [4, 5, 6]  # åªæ”¹å˜åˆ—è¡¨å†…å®¹ï¼Œä¸æ”¹å˜å¼•ç”¨

print(a)  # è¾“å‡º: [4, 5, 6]
print(b)  # è¾“å‡º: [4, 5, 6]ï¼Œå› ä¸º a å’Œ b å¼•ç”¨çš„æ˜¯åŒä¸€ä¸ªåˆ—è¡¨ï¼Œä¿®æ”¹ a çš„å†…å®¹ä¹Ÿå½±å“äº† b
```

å¦‚æœç›´æ¥ç”¨ `a = [4, 5, 6]` æ›¿æ¢ `[:]` æ“ä½œï¼Œé‚£ä¹ˆ `b` å°±ä¸ä¼šå—åˆ°å½±å“ï¼Œå› ä¸º `a` é‡æ–°æŒ‡å‘äº†ä¸€ä¸ªæ–°çš„åˆ—è¡¨å¯¹è±¡ã€‚
> 37ke
"""


@jitclass
class Simulator:
    cash: float  # è´¦æˆ·ç°é‡‘ä½™é¢, å•ä½äººæ°‘å¸å…ƒ
    pos_values: nb.float64[:]  # ä»“ä½ä»·å€¼ï¼Œå•ä½äººæ°‘å¸å…ƒ

    commission_rate: float  # äº¤æ˜“ä½£é‡‘è´¹ç‡ï¼Œè¡¨ç¤ºæ¯æ¬¡ä¹°å…¥æˆ–å–å‡ºè‚¡ç¥¨æ—¶ï¼ŒæŒ‰äº¤æ˜“é‡‘é¢æ”¶å–çš„ä½£é‡‘æ¯”ä¾‹
    stamp_tax_rate: float  # å°èŠ±ç¨ç‡ï¼Œä»…åœ¨å–å‡ºè‚¡ç¥¨æ—¶æ”¶å–ï¼ŒæŒ‰å–å‡ºé‡‘é¢çš„æ¯”ä¾‹è®¡ç®—

    last_prices: nb.float64[:]  # æœ€æ–°ä»·æ ¼

    def __init__(self, init_capital, commission_rate, stamp_tax_rate, init_pos_values):
        """
        åˆå§‹åŒ–æ¨¡æ‹Ÿå™¨

        :param init_capital: åˆå§‹èµ„é‡‘ï¼Œå•ä½äººæ°‘å¸å…ƒ
        :param commission_rate: äº¤æ˜“ä½£é‡‘è´¹ç‡ï¼Œè¡¨ç¤ºæ¯æ¬¡ä¹°å…¥æˆ–å–å‡ºè‚¡ç¥¨æ—¶ï¼ŒæŒ‰äº¤æ˜“é‡‘é¢æ”¶å–çš„ä½£é‡‘æ¯”ä¾‹ï¼ˆä¾‹å¦‚ 0.0003 è¡¨ç¤ºä¸‡åˆ†ä¹‹ä¸‰ï¼‰
        :param stamp_tax_rate: å°èŠ±ç¨ç‡ï¼Œä»…åœ¨å–å‡ºè‚¡ç¥¨æ—¶æ”¶å–ï¼ŒæŒ‰å–å‡ºé‡‘é¢çš„æ¯”ä¾‹è®¡ç®—ï¼ˆä¾‹å¦‚ 0.001 è¡¨ç¤ºåƒåˆ†ä¹‹ä¸€ï¼‰
        :param init_pos_values: åˆå§‹ä»“ä½ä»·å€¼ï¼Œè¡¨ç¤ºæ¯ä¸ªè‚¡ç¥¨çš„åˆå§‹æŒä»“ä»·å€¼ï¼Œå•ä½äººæ°‘å¸å…ƒ
        """
        self.cash = init_capital  # åˆå§‹åŒ–ç°é‡‘ä½™é¢ä¸ºåˆå§‹èµ„é‡‘
        self.commission_rate = commission_rate  # è®¾ç½®äº¤æ˜“ä½£é‡‘è´¹ç‡
        self.stamp_tax_rate = stamp_tax_rate  # è®¾ç½®å°èŠ±ç¨ç‡

        n = len(init_pos_values)  # è·å–åˆå§‹ä»“ä½ä»·å€¼çš„æ•°é‡

        # åˆå§‹åŒ–ä»“ä½ä»·å€¼æ•°ç»„ï¼Œé•¿åº¦ä¸ºnï¼Œæ•°æ®ç±»å‹ä¸ºfloat64
        self.pos_values = np.zeros(n, dtype=np.float64)
        self.pos_values[:] = init_pos_values  # å°†åˆå§‹ä»“ä½ä»·å€¼èµ‹å€¼ç»™ä»“ä½ä»·å€¼æ•°ç»„

        # åˆå§‹åŒ–æœ€æ–°ä»·æ ¼æ•°ç»„ï¼Œé•¿åº¦ä¸ºnï¼Œæ•°æ®ç±»å‹ä¸ºfloat64
        self.last_prices = np.zeros(n, dtype=np.float64)

    def deposit(self, cash):
        """
        æ¨¡æ‹Ÿå‘è´¦æˆ·ä¸­å­˜å…¥èµ„é‡‘

        :param cash: å…¥é‡‘é‡‘é¢ï¼Œå•ä½äººæ°‘å¸å…ƒã€‚å¿…é¡»ä¸ºéè´Ÿæ•°ã€‚
        """
        # æ£€æŸ¥å…¥é‡‘é‡‘é¢æ˜¯å¦ä¸ºè´Ÿæ•°ï¼Œå¦‚æœæ˜¯è´Ÿæ•°åˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œ
        if cash < 0:
            return
        # å°†å…¥é‡‘é‡‘é¢åŠ åˆ°å½“å‰ç°é‡‘ä½™é¢ä¸­
        self.cash += cash

    def withdraw(self, cash):
        """
        æ¨¡æ‹Ÿä»è´¦æˆ·ä¸­æå–èµ„é‡‘

        :param cash: å‡ºé‡‘é‡‘é¢ï¼Œå•ä½äººæ°‘å¸å…ƒã€‚å¿…é¡»ä¸ºéè´Ÿæ•°ã€‚
        :return: å®é™…æå–çš„é‡‘é¢ã€‚å¦‚æœè¯·æ±‚çš„é‡‘é¢å¤§äºå½“å‰ç°é‡‘ä½™é¢ï¼Œåˆ™è¿”å›å½“å‰å…¨éƒ¨å¯ç”¨ç°é‡‘ã€‚
        """
        # æ£€æŸ¥å‡ºé‡‘é‡‘é¢æ˜¯å¦ä¸ºè´Ÿæ•°ï¼Œå¦‚æœæ˜¯è´Ÿæ•°åˆ™è¿”å› 0ï¼Œè¡¨ç¤ºæœªæå–ä»»ä½•èµ„é‡‘
        if cash < 0:
            return 0

        # å¦‚æœè¯·æ±‚çš„å‡ºé‡‘é‡‘é¢å¤§äºå½“å‰ç°é‡‘ä½™é¢ï¼Œåˆ™å°†å‡ºé‡‘é‡‘é¢è°ƒæ•´ä¸ºå½“å‰ç°é‡‘ä½™é¢
        if cash > self.cash:
            cash = self.cash

        # ä»å½“å‰ç°é‡‘ä½™é¢ä¸­æ‰£é™¤å‡ºé‡‘é‡‘é¢
        self.cash -= cash
        # è¿”å›å®é™…æå–çš„é‡‘é¢
        return cash

    def withdraw_all(self):
        """
        æå–è´¦æˆ·ä¸­å…¨éƒ¨å¯ç”¨ç°é‡‘

        :return: è´¦æˆ·ä¸­å…¨éƒ¨å¯ç”¨ç°é‡‘çš„é‡‘é¢ï¼Œå•ä½äººæ°‘å¸å…ƒã€‚
        """
        # è°ƒç”¨ withdraw æ–¹æ³•ï¼Œæå–å½“å‰å…¨éƒ¨ç°é‡‘ä½™é¢
        return self.withdraw(self.cash)

    def fill_last_prices(self, prices):
        """
        æ›´æ–°æœ€æ–°ä»·æ ¼æ•°ç»„ `last_prices`ï¼Œå°†é NaN çš„ä»·æ ¼å¡«å……åˆ°å¯¹åº”ä½ç½®

        :param prices: å½“å‰ä»·æ ¼æ•°ç»„ï¼Œå¯èƒ½åŒ…å« NaN å€¼
        """
        # åˆ›å»ºä¸€ä¸ªå¸ƒå°”æ©ç ï¼Œæ ‡è®° prices æ•°ç»„ä¸­é NaN çš„ä½ç½®
        mask = np.logical_not(np.isnan(prices))
        # å°† prices æ•°ç»„ä¸­é NaN çš„å€¼æ›´æ–°åˆ° last_prices æ•°ç»„çš„å¯¹åº”ä½ç½®
        self.last_prices[mask] = prices[mask]

    def settle_pos_values(self, prices):
        """
        æ ¹æ®å½“å‰ä»·æ ¼è®¡ç®—å¹¶æ›´æ–°ä»“ä½ä»·å€¼ `pos_values`

        :param prices: å½“å‰ä»·æ ¼æ•°ç»„ï¼Œå¯èƒ½åŒ…å« NaN å€¼
        """
        # åˆ›å»ºä¸€ä¸ªå¸ƒå°”æ©ç ï¼Œæ ‡è®°æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„ä½ç½®ï¼š
        # 1. pos_values å¤§äº 1e-6ï¼ˆé¿å…æå°å€¼çš„å½±å“ï¼‰
        # 2. prices æ•°ç»„ä¸­å¯¹åº”ä½ç½®çš„å€¼ä¸æ˜¯ NaN
        mask = np.logical_and(self.pos_values > 1e-6, np.logical_not(np.isnan(prices)))

        # æ ¹æ®å½“å‰ä»·æ ¼å’Œä¸Šä¸€æ¬¡ä»·æ ¼çš„æ¯”ç‡ï¼Œæ›´æ–°ä»“ä½ä»·å€¼
        # å…¬å¼ï¼špos_values = pos_values * (å½“å‰ä»·æ ¼ / ä¸Šä¸€æ¬¡ä»·æ ¼)
        self.pos_values[mask] *= prices[mask] / self.last_prices[mask]

    def get_pos_value(self):
        """
        è®¡ç®—å¹¶è¿”å›å½“å‰æ‰€æœ‰ä»“ä½çš„æ€»ä»·å€¼

        :return: æ‰€æœ‰ä»“ä½çš„æ€»ä»·å€¼ï¼Œå•ä½äººæ°‘å¸å…ƒ
        """
        # ä½¿ç”¨ numpy çš„ sum å‡½æ•°å¯¹ pos_values æ•°ç»„æ±‚å’Œï¼Œå¾—åˆ°æ‰€æœ‰ä»“ä½çš„æ€»ä»·å€¼
        return np.sum(self.pos_values)

    def sell_all(self, exec_prices):
        """
        å–å‡ºæ‰€æœ‰æŒä»“ï¼Œå°†å½“å‰ä»“ä½è°ƒæ•´ä¸º 0ï¼Œå¹¶è¿”å›äº¤æ˜“å°èŠ±ç¨å’Œä½£é‡‘

        :param exec_prices: å–å‡ºä»·æ ¼æ•°ç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªè‚¡ç¥¨çš„å–å‡ºä»·æ ¼
        :return: å°èŠ±ç¨å’Œä½£é‡‘ï¼Œå•ä½äººæ°‘å¸å…ƒ
        """
        # åˆ›å»ºä¸€ä¸ªå…¨é›¶æ•°ç»„ï¼Œè¡¨ç¤ºç›®æ ‡ä»“ä½ä¸º 0ï¼ˆå³æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼‰
        target_pos = np.zeros(len(self.pos_values), dtype=np.float64)

        # è°ƒç”¨ adjust_positions æ–¹æ³•ï¼Œå°†ä»“ä½è°ƒæ•´ä¸º 0ï¼Œå¹¶è¿”å›å°èŠ±ç¨å’Œä½£é‡‘
        stamp_tax, commission = self.adjust_positions(exec_prices, target_pos)

        # è¿”å›å°èŠ±ç¨å’Œä½£é‡‘
        return stamp_tax, commission

    def adjust_positions(self, exec_prices, target_pos):
        """
        æ¨¡æ‹Ÿè°ƒä»“æ“ä½œï¼Œæ ¹æ®ç›®æ ‡ä»“ä½å’Œè°ƒä»“ä»·æ ¼è°ƒæ•´å½“å‰ä»“ä½ï¼Œå¹¶è®¡ç®—äº¤æ˜“æˆæœ¬å’Œæ›´æ–°è´¦æˆ·çŠ¶æ€

        :param exec_prices: è°ƒä»“ä»·æ ¼æ•°ç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªè‚¡ç¥¨çš„è°ƒä»“ä»·æ ¼
        :param target_pos: ç›®æ ‡ä»“ä½æ•°ç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªè‚¡ç¥¨çš„ç›®æ ‡æŒä»“æ•°é‡
        :return: äº¤æ˜“ä½£é‡‘ï¼Œå•ä½äººæ°‘å¸å…ƒ
        """
        # æ ¹æ®è°ƒä»“ä»·æ ¼å’Œä¸Šä¸€æ¬¡çš„æœ€æ–°ä»·æ ¼ï¼ˆå¼€ç›˜ä»·ï¼‰ï¼Œç»“ç®—å½“å‰ä»“ä½ä»·å€¼
        self.settle_pos_values(exec_prices)

        # åˆå§‹åŒ–ç›®æ ‡ä»“ä½ä»·å€¼æ•°ç»„ï¼Œé•¿åº¦ä¸ pos_values ç›¸åŒï¼Œæ•°æ®ç±»å‹ä¸º float64
        target_values = np.zeros(len(self.pos_values), dtype=np.float64)

        # åˆ›å»ºä¸€ä¸ªå¸ƒå°”æ©ç ï¼Œæ ‡è®°ç›®æ ‡ä»“ä½å¤§äº 0 çš„ä½ç½®
        mask = target_pos > 0
        # è®¡ç®—ç›®æ ‡ä»“ä½ä»·å€¼ï¼šç›®æ ‡ä»“ä½ä»·å€¼ = è°ƒä»“ä»·æ ¼ * ç›®æ ‡æŒä»“æ•°é‡
        target_values[mask] = exec_prices[mask] * target_pos[mask]

        # è®¡ç®—ä»“ä½ä»·å€¼çš„å˜åŒ–é‡ï¼šç›®æ ‡ä»“ä½ä»·å€¼ - å½“å‰ä»“ä½ä»·å€¼
        delta_values = target_values - self.pos_values

        # è®¡ç®—ä¹°å…¥æˆäº¤é¢ï¼šæ‰€æœ‰ä»“ä½ä»·å€¼å˜åŒ–é‡ä¸ºæ­£çš„éƒ¨åˆ†ä¹‹å’Œ
        buy_turnover = np.sum(delta_values[delta_values > 0])

        # è®¡ç®—å–å‡ºæˆäº¤é¢ï¼šæ‰€æœ‰ä»“ä½ä»·å€¼å˜åŒ–é‡ä¸ºè´Ÿçš„éƒ¨åˆ†ä¹‹å’Œï¼ˆå–ç»å¯¹å€¼ï¼‰
        sell_turnover = -np.sum(delta_values[delta_values < 0])

        # å°†å½“å‰ä»“ä½ä»·å€¼æ›´æ–°ä¸ºç›®æ ‡ä»“ä½ä»·å€¼
        self.pos_values[:] = target_values

        # è®¡ç®—åˆ¸å•†ä½£é‡‘ï¼šä½£é‡‘ = (ä¹°å…¥æˆäº¤é¢ + å–å‡ºæˆäº¤é¢) * ä½£é‡‘è´¹ç‡
        commission = (buy_turnover + sell_turnover) * self.commission_rate

        # è®¡ç®—å°èŠ±ç¨ï¼šå°èŠ±ç¨ = å–å‡ºæˆäº¤é¢ * å°èŠ±ç¨ç‡
        stamp_tax = sell_turnover * self.stamp_tax_rate

        # æ›´æ–°è´¦æˆ·ç°é‡‘ä½™é¢ï¼š
        # ç°é‡‘å˜åŒ– = å–å‡ºæˆäº¤é¢ - ä¹°å…¥æˆäº¤é¢ - ä½£é‡‘ - å°èŠ±ç¨
        self.cash += sell_turnover - buy_turnover - commission - stamp_tax

        # æ›´æ–°æœ€æ–°ä»·æ ¼ä¸ºè°ƒä»“ä»·æ ¼
        self.fill_last_prices(exec_prices)

        # è¿”å›äº¤æ˜“ä½£é‡‘
        return stamp_tax, commission
