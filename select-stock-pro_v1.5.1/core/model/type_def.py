"""
é‚¢ä¸è¡Œï½œç­–ç•¥åˆ†äº«ä¼š
è‚¡ç¥¨é‡åŒ–ç­–ç•¥æ¡†æ¶ğ“Ÿğ“»ğ“¸

ç‰ˆæƒæ‰€æœ‰ Â©ï¸ é‚¢ä¸è¡Œ
å¾®ä¿¡: xbx1717

æœ¬ä»£ç ä»…ä¾›ä¸ªäººå­¦ä¹ ä½¿ç”¨ï¼Œæœªç»æˆæƒä¸å¾—å¤åˆ¶ã€ä¿®æ”¹æˆ–ç”¨äºå•†ä¸šç”¨é€”ã€‚

Author: é‚¢ä¸è¡Œ
"""

import numba as nb
from numba.experimental import jitclass

# å®šä¹‰è‚¡ç¥¨äº¤æ˜“æ‰€ç±»å‹çš„å¸¸é‡
# åŒ—äº¤æ‰€(ç†åº”æ‹‰é»‘) bjxxxxxx
BSE_MAIN = 0

# ä¸Šäº¤æ‰€ä¸»æ¿ sh60xxxx
SSE_MAIN = 1

# ä¸Šäº¤æ‰€ç§‘åˆ›æ¿ sh68xxxx
SSE_STAR = 2

# æ·±äº¤æ‰€ä¸»æ¿ sz00xxxx
SZSE_MAIN = 3

# æ·±äº¤æ‰€åˆ›ä¸šæ¿ sz30xxxx
SZSE_CHINEXT = 4

# ä»·æ ¼åºåˆ—æ•°æ®
price_array = [
    "open",
    "0935",
    "0940",
    "0945",
    "0950",
    "0955",
    "1000",
    "1005",
    "1010",
    "1015",
    "1020",
    "1025",
    "1030",
    "1035",
    "1040",
    "1045",
    "1050",
    "1055",
    "1100",
    "1105",
    "1110",
    "1115",
    "1120",
    "1125",
    "1130",
    "1305",
    "1310",
    "1315",
    "1320",
    "1325",
    "1330",
    "1335",
    "1340",
    "1345",
    "1350",
    "1355",
    "1400",
    "1405",
    "1410",
    "1415",
    "1420",
    "1425",
    "1430",
    "1435",
    "1440",
    "1445",
    "1450",
    "1455",
    "close",
]


@jitclass
class StockMarketData:
    """
    è‚¡ç¥¨å¸‚åœºæ•°æ®ç±»ï¼Œç”¨äºå­˜å‚¨å’Œç®¡ç†è‚¡ç¥¨å¸‚åœºçš„å†å²æ•°æ®
    """

    # äº¤æ˜“æ—¥é›¶ç‚¹æ—¶é—´æˆ³ï¼Œå•ä½ç§’
    candle_begin_ts: nb.int64[:]

    # å‰æ”¶ç›˜ä»·æ•°æ®ï¼ŒäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´è¡¨ç¤ºè‚¡ç¥¨ï¼Œç¬¬äºŒç»´è¡¨ç¤ºæ—¶é—´
    pre_cl: nb.float64[:, :]

    # ä»·æ ¼æ•°æ®ï¼ŒåŒ…å«å¼€ç›˜ä»·ã€æ—¥å†…ä¸åŒæ—¶é—´ç‚¹ä»·æ ¼å’Œæ”¶ç›˜ä»·
    prices: nb.types.UniTuple(nb.float64[:, :], 49)

    # è‚¡ç¥¨æ‰€å±äº¤æ˜“æ‰€ç±»å‹æ•°ç»„ï¼Œè¡¨ç¤ºæ¯åªè‚¡ç¥¨å¯¹åº”çš„äº¤æ˜“æ‰€ç±»å‹ï¼ˆå¦‚ BSE_MAIN, SSE_MAIN ç­‰ï¼‰
    types: nb.int16[:]

    def __init__(self, candle_begin_ts, op, cl, pre_cl, types, hour_prices=()):
        """
        åˆå§‹åŒ–è‚¡ç¥¨å¸‚åœºæ•°æ®

        :param candle_begin_ts: äº¤æ˜“æ—¥é›¶ç‚¹æ—¶é—´æˆ³æ•°ç»„ï¼Œå•ä½ç§’
        :param op: å¼€ç›˜ä»·æ•°æ®ï¼ŒäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´è¡¨ç¤ºè‚¡ç¥¨ï¼Œç¬¬äºŒç»´è¡¨ç¤ºæ—¶é—´
        :param cl: æ”¶ç›˜ä»·æ•°æ®ï¼ŒäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´è¡¨ç¤ºè‚¡ç¥¨ï¼Œç¬¬äºŒç»´è¡¨ç¤ºæ—¶é—´
        :param pre_cl: å‰æ”¶ç›˜ä»·æ•°æ®ï¼ŒäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´è¡¨ç¤ºè‚¡ç¥¨ï¼Œç¬¬äºŒç»´è¡¨ç¤ºæ—¶é—´
        :param types: è‚¡ç¥¨æ‰€å±äº¤æ˜“æ‰€ç±»å‹æ•°ç»„ï¼Œè¡¨ç¤ºæ¯åªè‚¡ç¥¨å¯¹åº”çš„äº¤æ˜“æ‰€ç±»å‹
        :param hour_prices: æ—¥å†…ä¸åŒæ—¶é—´ç‚¹ä»·æ ¼æ•°æ®ï¼ŒåŒ…å« 3 ä¸ªäºŒç»´æ•°ç»„çš„å…ƒç»„ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸åŒæ—¶é—´ç‚¹çš„ä»·æ ¼
        """
        # äº¤æ˜“æ—¥é›¶ç‚¹æ—¶é—´æˆ³
        self.candle_begin_ts = candle_begin_ts
        self.prices = (
            op,
            hour_prices[0],
            hour_prices[1],
            hour_prices[2],
            hour_prices[3],
            hour_prices[4],
            hour_prices[5],
            hour_prices[6],
            hour_prices[7],
            hour_prices[8],
            hour_prices[9],
            hour_prices[10],
            hour_prices[11],
            hour_prices[12],
            hour_prices[13],
            hour_prices[14],
            hour_prices[15],
            hour_prices[16],
            hour_prices[17],
            hour_prices[18],
            hour_prices[19],
            hour_prices[20],
            hour_prices[21],
            hour_prices[22],
            hour_prices[23],
            hour_prices[24],
            hour_prices[25],
            hour_prices[26],
            hour_prices[27],
            hour_prices[28],
            hour_prices[29],
            hour_prices[30],
            hour_prices[31],
            hour_prices[32],
            hour_prices[33],
            hour_prices[34],
            hour_prices[35],
            hour_prices[36],
            hour_prices[37],
            hour_prices[38],
            hour_prices[39],
            hour_prices[40],
            hour_prices[41],
            hour_prices[42],
            hour_prices[43],
            hour_prices[44],
            hour_prices[45],
            hour_prices[46],
            cl,
        )

        # å‰æ”¶ç›˜ä»·æ•°æ®
        self.pre_cl = pre_cl

        # è‚¡ç¥¨æ‰€å±äº¤æ˜“æ‰€ç±»å‹
        self.types = types


@jitclass
class SimuParams:
    """
    æ¨¡æ‹Ÿå‚æ•°ç±»ï¼Œç”¨äºå®šä¹‰æ¨¡æ‹Ÿäº¤æ˜“ä¸­çš„åˆå§‹èµ„é‡‘ã€äº¤æ˜“ä½£é‡‘å’Œå°èŠ±ç¨ç­‰å‚æ•°
    """

    # åˆå§‹èµ„é‡‘ï¼Œå•ä½äººæ°‘å¸å…ƒ
    init_cash: float

    # åˆ¸å•†ä½£é‡‘è´¹ç‡ï¼Œè¡¨ç¤ºæ¯æ¬¡äº¤æ˜“ï¼ˆä¹°å…¥æˆ–å–å‡ºï¼‰æ—¶æŒ‰äº¤æ˜“é‡‘é¢æ”¶å–çš„ä½£é‡‘æ¯”ä¾‹
    commission_rate: float

    # å°èŠ±ç¨ç‡ï¼Œè¡¨ç¤ºå–å‡ºè‚¡ç¥¨æ—¶æŒ‰å–å‡ºé‡‘é¢æ”¶å–çš„ç¨ç‡
    stamp_tax_rate: float

    def __init__(self, init_cash, commission_rate, stamp_tax_rate):
        """
        åˆå§‹åŒ–æ¨¡æ‹Ÿå‚æ•°

        :param init_cash: åˆå§‹èµ„é‡‘ï¼Œå•ä½äººæ°‘å¸å…ƒ
        :param commission_rate: åˆ¸å•†ä½£é‡‘è´¹ç‡ï¼Œè¡¨ç¤ºæ¯æ¬¡äº¤æ˜“ï¼ˆä¹°å…¥æˆ–å–å‡ºï¼‰æ—¶æŒ‰äº¤æ˜“é‡‘é¢æ”¶å–çš„ä½£é‡‘æ¯”ä¾‹
        :param stamp_tax_rate: å°èŠ±ç¨ç‡ï¼Œè¡¨ç¤ºå–å‡ºè‚¡ç¥¨æ—¶æŒ‰å–å‡ºé‡‘é¢æ”¶å–çš„ç¨ç‡
        """
        # è®¾ç½®åˆå§‹èµ„é‡‘
        self.init_cash = init_cash

        # è®¾ç½®åˆ¸å•†ä½£é‡‘è´¹ç‡
        self.commission_rate = commission_rate

        # è®¾ç½®å°èŠ±ç¨ç‡
        self.stamp_tax_rate = stamp_tax_rate


@jitclass
class AdjustRatios:
    """
    è°ƒä»“å‚æ•°ç±»ï¼Œç”¨äºå®šä¹‰è°ƒä»“æ“ä½œçš„æ—¥æœŸã€ç›®æ ‡æƒé‡ä»¥åŠä¹°å–ä»·æ ¼ç´¢å¼•
    """

    # è°ƒä»“æ—¥æœŸæ•°ç»„ï¼Œå­˜å‚¨æ¯æ¬¡è°ƒä»“çš„æ—¶é—´æˆ³ï¼ˆå•ä½ï¼šç§’ï¼‰
    adj_dts: nb.int64[:]

    # ç›®æ ‡æƒé‡çŸ©é˜µï¼ŒäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´è¡¨ç¤ºè°ƒä»“æ—¥æœŸï¼Œç¬¬äºŒç»´è¡¨ç¤ºæ¯ä¸ªè‚¡ç¥¨çš„ç›®æ ‡æƒé‡
    ratios: nb.float64[:, :]

    # å–å‡ºä»·æ ¼ç´¢å¼•ï¼Œè¡¨ç¤ºåœ¨ä»·æ ¼æ•°æ®ä¸­ä½¿ç”¨å“ªä¸ªæ—¶é—´ç‚¹çš„ä»·æ ¼ä½œä¸ºå–å‡ºä»·æ ¼
    sp_idx: nb.int8

    # ä¹°å…¥ä»·æ ¼ç´¢å¼•ï¼Œè¡¨ç¤ºåœ¨ä»·æ ¼æ•°æ®ä¸­ä½¿ç”¨å“ªä¸ªæ—¶é—´ç‚¹çš„ä»·æ ¼ä½œä¸ºä¹°å…¥ä»·æ ¼
    bp_idx: nb.int8

    def __init__(self, adj_dts, ratios, reb_time):
        """
        åˆå§‹åŒ–è°ƒä»“å‚æ•°

        :param adj_dts: è°ƒä»“æ—¥æœŸæ•°ç»„ï¼Œå­˜å‚¨æ¯æ¬¡è°ƒä»“çš„æ—¶é—´æˆ³ï¼ˆå•ä½ï¼šç§’ï¼‰
        :param ratios: ç›®æ ‡æƒé‡çŸ©é˜µï¼ŒäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´è¡¨ç¤ºè°ƒä»“æ—¥æœŸï¼Œç¬¬äºŒç»´è¡¨ç¤ºæ¯ä¸ªè‚¡ç¥¨çš„ç›®æ ‡æƒé‡
        :param reb_time: ä¹°å–ä»·æ ¼ç´¢å¼•å…ƒç»„ï¼Œæ ¼å¼ä¸º (å–å‡ºä»·æ ¼ç´¢å¼•, ä¹°å…¥ä»·æ ¼ç´¢å¼•)
        """
        # è®¾ç½®è°ƒä»“æ—¥æœŸ
        self.adj_dts = adj_dts

        # è®¾ç½®ç›®æ ‡æƒé‡çŸ©é˜µ
        self.ratios = ratios

        # è®¾ç½®å–å‡ºä»·æ ¼ç´¢å¼•å’Œä¹°å…¥ä»·æ ¼ç´¢å¼•
        self.sp_idx, self.bp_idx = reb_time


def get_symbol_type(symbol: str) -> int:
    """
    æ ¹æ®è‚¡ç¥¨ä»£ç åˆ¤æ–­å…¶æ‰€å±çš„äº¤æ˜“æ‰€ç±»å‹

    :param symbol: è‚¡ç¥¨ä»£ç ï¼Œæ ¼å¼ä¸ºäº¤æ˜“æ‰€ä»£ç  + è‚¡ç¥¨ç¼–å·(ä¾‹å¦‚ sh600000, sz000001, bj430090)
    :return: äº¤æ˜“æ‰€ç±»å‹å¸¸é‡ï¼ˆå¦‚ BSE_MAIN, SSE_MAIN, SSE_STAR, SZSE_MAIN, SZSE_CHINEXT)
    :raises ValueError: å¦‚æœè‚¡ç¥¨ä»£ç ä¸ç¬¦åˆå·²çŸ¥çš„äº¤æ˜“æ‰€ä»£ç è§„åˆ™ï¼ŒæŠ›å‡º ValueError
    """
    # åˆ¤æ–­æ˜¯å¦ä¸ºåŒ—äº¤æ‰€è‚¡ç¥¨ï¼ˆä»£ç ä»¥ 'bj' å¼€å¤´ï¼‰
    if symbol.startswith("bj"):
        return BSE_MAIN  # åŒ—äº¤æ‰€

    # åˆ¤æ–­æ˜¯å¦ä¸ºä¸Šäº¤æ‰€è‚¡ç¥¨ï¼ˆä»£ç ä»¥ 'sh' å¼€å¤´ï¼‰
    if symbol.startswith("sh"):
        # åˆ¤æ–­æ˜¯å¦ä¸ºç§‘åˆ›æ¿è‚¡ç¥¨ï¼ˆä»£ç ä»¥ 'sh68' å¼€å¤´ï¼‰
        if symbol.startswith("sh68"):
            return SSE_STAR  # ç§‘åˆ›æ¿
        else:
            return SSE_MAIN  # ä¸Šäº¤æ‰€ä¸»æ¿

    # åˆ¤æ–­æ˜¯å¦ä¸ºæ·±äº¤æ‰€è‚¡ç¥¨ï¼ˆä»£ç ä»¥ 'sz' å¼€å¤´ï¼‰
    if symbol.startswith("sz"):
        # åˆ¤æ–­æ˜¯å¦ä¸ºæ·±äº¤æ‰€ä¸»æ¿è‚¡ç¥¨ï¼ˆä»£ç ä»¥ 'sz0' å¼€å¤´ï¼‰
        if symbol.startswith("sz0"):
            return SZSE_MAIN  # æ·±äº¤æ‰€ä¸»æ¿
        else:
            return SZSE_CHINEXT  # æ·±äº¤æ‰€åˆ›ä¸šæ¿

    # å¦‚æœè‚¡ç¥¨ä»£ç ä¸ç¬¦åˆå·²çŸ¥è§„åˆ™ï¼ŒæŠ›å‡º ValueError
    raise ValueError(f"Unknown stock {symbol}")
