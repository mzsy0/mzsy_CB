"""
é‚¢ä¸è¡Œï½œç­–ç•¥åˆ†äº«ä¼š
è‚¡ç¥¨é‡åŒ–ç­–ç•¥æ¡†æ¶ğ“Ÿğ“»ğ“¸

ç‰ˆæƒæ‰€æœ‰ Â©ï¸ é‚¢ä¸è¡Œ
å¾®ä¿¡: xbx1717

æœ¬ä»£ç ä»…ä¾›ä¸ªäººå­¦ä¹ ä½¿ç”¨ï¼Œæœªç»æˆæƒä¸å¾—å¤åˆ¶ã€ä¿®æ”¹æˆ–ç”¨äºå•†ä¸šç”¨é€”ã€‚

Author: é‚¢ä¸è¡Œ
"""
import shutil
import time

from config import n_jobs
from core.data_center import prepare_data
from core.equity import simulate_performance
from core.model.backtest_config import BacktestConfig, BacktestConfigFactory
from core.select_stock import calculate_factors, select_stocks, concat_select_results
from core.utils.log_kit import divider, logger

# ====================================================================================================
# æ¨¡æ‹Ÿäº¤æ˜“
# 1. è®¡ç®—åˆå§‹èµ„é‡‘æ›²çº¿
# 2. ä¿å­˜å›æµ‹ç»“æœï¼ŒåŒ…æ‹¬èµ„é‡‘æ›²çº¿å’Œå„é¡¹æ”¶ç›Šè¯„ä»·æŒ‡æ ‡
# 3. å¯é€‰ï¼šæ˜¾ç¤ºèµ„é‡‘æ›²çº¿å›¾è¡¨
# 4. å¦‚æœ‰æ‹©æ—¶ä¿¡å·ï¼Œæ‰§è¡Œå†æ‹©æ—¶æ¨¡æ‹Ÿå¹¶ä¿å­˜ç»“æœ
# ====================================================================================================
pass

# ====================================================================================================
# åŠ¨æ€æ æ†å†æ‹©æ—¶æ¨¡æ‹Ÿ
# 1. ç”ŸæˆåŠ¨æ€æ æ†
# 2. è¿›è¡ŒåŠ¨æ€æ æ†å†æ‹©æ—¶çš„å›æµ‹æ¨¡æ‹Ÿ
# 3. ä¿å­˜ç»“æœ
# ====================================================================================================
pass


# ====================================================================================================
# ** å›æµ‹ä¸»ç¨‹åº **
# 1. å‡†å¤‡å·¥ä½œ
# 2. è¯»å–æ•°æ®
# 3. è®¡ç®—å› å­
# 4. é€‰è‚¡
# 5. æ•´ç†é€‰è‚¡æ•°æ®
# 6. æ·»åŠ ä¸‹ä¸€ä¸ªæ¯ä¸€ä¸ªå‘¨æœŸéœ€è¦å–å‡ºçš„å¸çš„ä¿¡æ¯
# 7. è®¡ç®—èµ„é‡‘æ›²çº¿
# ====================================================================================================
def run_backtest(conf: BacktestConfig, require_simulate=True):
    """
    ** å›æµ‹ä¸»ç¨‹åºæµç¨‹ **
    æœ¬è„šæœ¬æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
    0. åˆå§‹é…ç½®ä¸å‡†å¤‡
    1. æ•°æ®å‡†å¤‡ï¼šåŠ è½½å¹¶é¢„å¤„ç†å›æµ‹æ‰€éœ€æ•°æ®
    2. å› å­è®¡ç®—ï¼šè®¡ç®—ç”¨äºé€‰è‚¡çš„å› å­
    3. é€‰è‚¡ï¼šåŸºäºå› å­ç»“æœç­›é€‰ç›®æ ‡è‚¡ç¥¨
    4. å®ç›˜æ¨¡æ‹Ÿï¼šæ¨¡æ‹ŸæŠ•èµ„ç»„åˆçš„è¡¨ç°ï¼Œç”Ÿæˆèµ„é‡‘æ›²çº¿
    """
    # ====================================================================================================
    # 1. è¯»å–å›æµ‹æ‰€éœ€æ•°æ®ï¼Œå¹¶åšç®€å•çš„é¢„å¤„ç†
    # - åŠ è½½å†å²è¡Œæƒ…æ•°æ®æˆ–å…¶ä»–ç›¸å…³æ•°æ®
    # ====================================================================================================
    # è°ƒç”¨æ•°æ®å‡†å¤‡å‡½æ•°ï¼ŒåŠ è½½å¹¶é¢„å¤„ç†å›æµ‹æ‰€éœ€çš„æ•°æ®
    divider(f'{conf.name}@å‡†å¤‡æ•°æ®', '-')

    # ç¼“å­˜å½“å‰çš„config
    conf.save()

    runtime_folder = conf.get_runtime_folder()

    logger.debug(f'ğŸ§¹ åˆ é™¤è¿è¡Œç¼“å­˜æ–‡ä»¶å¤¹ï¼š{runtime_folder}')
    shutil.rmtree(runtime_folder, ignore_errors=True)
    runtime_folder.mkdir(parents=True, exist_ok=True)
    prepare_data(conf)

    # ====================================================================================================
    # 2. å› å­è®¡ç®—
    # ====================================================================================================
    # æ ¹æ®é…ç½®æ–‡ä»¶è®¡ç®—ç­–ç•¥å› å­å’Œè¿‡æ»¤å› å­
    divider(f'{conf.name}@å› å­è®¡ç®—', '-')
    calculate_factors(conf)

    # ====================================================================================================
    # 3. é€‰è‚¡
    # ====================================================================================================
    # æ ¹æ®è®¡ç®—å¾—åˆ°çš„å› å­è¿›è¡Œé€‰è‚¡
    divider(f'{conf.name}@æ¡ä»¶é€‰è‚¡', '-')
    s_time = time.time()
    select_stocks(conf)
    select_results = concat_select_results(conf)  # åˆå¹¶å¤šä¸ªç­–ç•¥çš„é€‰è‚¡ç»“æœ

    logger.debug(f'ğŸ’¾ é€‰è‚¡ç»“æœæ•°æ®å¤§å°ï¼š{select_results.memory_usage(deep=True).sum() / 1024 / 1024:.4f} MB')
    logger.ok(f'é€‰è‚¡å®Œæˆï¼Œæ€»è€—æ—¶ï¼š{time.time() - s_time:.3f}ç§’')

    if not require_simulate:
        return

    # ====================================================================================================
    # 4. å®ç›˜æ¨¡æ‹Ÿèµ„é‡‘æ›²çº¿
    # ====================================================================================================
    # åŸºäºé€‰è‚¡ç»“æœï¼Œæ¨¡æ‹ŸæŠ•èµ„ç»„åˆè¡¨ç°å¹¶ç”Ÿæˆèµ„é‡‘æ›²çº¿
    divider(f'{conf.name}@æ¨¡æ‹Ÿäº¤æ˜“', '-')
    simulate_performance(conf)


# ====================================================================================================
# ** æ‰¹é‡å›æµ‹ **
# 1. å‡†å¤‡å·¥ä½œï¼šæ¸…ç†ç¯å¢ƒï¼Œåˆå§‹åŒ–å‚æ•°é…ç½®
# 2. è¯»å–æ•°æ®ï¼šåŠ è½½å›æµ‹æ‰€éœ€çš„è¡Œæƒ…æ•°æ®
# 3. è®¡ç®—å› å­ï¼šæ ¹æ®ç­–ç•¥è¦æ±‚è®¡ç®—é€‰è‚¡å› å­
# 4. é€‰è‚¡å’Œè®¡ç®—èµ„é‡‘æ›²çº¿ï¼šå¹¶è¡Œå›æµ‹é€‰è‚¡ç»“æœå¹¶ç”Ÿæˆèµ„é‡‘æ›²çº¿
# 5. é’ˆå¯¹é€‰è‚¡ç»“æœè¿›è¡Œèšåˆ
# ====================================================================================================
def run_backtest_multi(factory: BacktestConfigFactory, boost=True):
    # ====================================================================================================
    # 1. å‡†å¤‡å·¥ä½œ
    # ====================================================================================================
    iter_results_folder = factory.result_folder

    # åˆ é™¤ç¼“å­˜
    shutil.rmtree(iter_results_folder, ignore_errors=True)
    iter_results_folder.mkdir(parents=True, exist_ok=True)

    conf_list = factory.config_list
    for index, conf in enumerate(conf_list):
        logger.debug(f'â„¹ï¸ ç­–ç•¥{index + 1}ï½œå…±{len(conf_list)}ä¸ª')
        logger.debug(f'{conf.get_fullname()}')
        conf.save()
    logger.ok('ç­–ç•¥æ± ä¸­éœ€è¦å›æµ‹çš„ç­–ç•¥æ•°ï¼š{}'.format(len(conf_list)))

    # è®°å½•ä¸€ä¸‹æ—¶é—´æˆ³
    r_time = time.time()

    # ====================================================================================================
    # 2. è¯»å–å›æµ‹æ‰€éœ€æ•°æ®ï¼Œå¹¶åšç®€å•çš„é¢„å¤„ç†
    # ====================================================================================================
    divider(f'{factory.backtest_name}@è¯»å–æ•°æ®', sep='-')
    conf_all = factory.generate_all_factor_config()
    prepare_data(conf_all, boost=True)

    # ====================================================================================================
    # 3. è®¡ç®—å› å­
    # ====================================================================================================
    divider(f'{factory.backtest_name}@å› å­è®¡ç®—', sep='-')
    calculate_factors(conf_all, boost=True)

    # ====================================================================================================
    # 4. é€‰è‚¡
    # - æ³¨æ„ï¼šé€‰å®Œä¹‹åï¼Œæ¯ä¸€ä¸ªç­–ç•¥çš„é€‰è‚¡ç»“æœä¼šè¢«ä¿å­˜åˆ°ç¡¬ç›˜
    # ====================================================================================================
    divider(f'{factory.backtest_name}@æ¡ä»¶é€‰è‚¡', sep='-')
    s_time = time.time()
    logger.debug(f'æ³¨æ„ï¼šè¿™ä¸ªè¿‡ç¨‹æ—¶é—´ä¹…ï¼Œå’ŒåŒ…å«çš„ç­–ç•¥åŠå­ç­–ç•¥æ•°é‡ã€é€‰è‚¡æ•°é‡æœ‰å…³...')

    logger.debug(f'ğŸš€ å¤šè¿›ç¨‹é€‰è‚¡ï¼Œè¿›ç¨‹æ•°é‡ï¼š{n_jobs}ã€‚è¦æ˜¯é•¿æœŸå¡ä½ï¼Œå»ºè®®å…ˆå•è¿›ç¨‹æµ‹è¯•' if boost else 'ğŸš² å•è¿›ç¨‹é€‰è‚¡')
    if boost:
        select_stocks(factory.config_list, boost=False)
    else:
        for conf in factory.config_list:
            logger.info(f'{conf.name}çš„{len(conf.strategy_list)}ä¸ªå­ç­–ç•¥é€‰è‚¡')
            select_stocks(conf, boost=False)  # é€‰è‚¡

    logger.ok(f'å®Œæˆé€‰è‚¡ï¼ŒèŠ±è´¹æ—¶é—´ï¼š{time.time() - s_time:.3f}ç§’ï¼Œç´¯è®¡æ—¶é—´ï¼š{(time.time() - r_time):.3f}ç§’')

    # ====================================================================================================
    # 5. é’ˆå¯¹é€‰è‚¡ç»“æœè¿›è¡Œèšåˆ
    # ====================================================================================================
    divider(f'{factory.backtest_name}@å­ç­–ç•¥æ¨¡æ‹Ÿ', sep='-')
    logger.debug(f'æ³¨æ„ï¼šä¸»è¦å’Œé€‰è‚¡æ•°é‡æœ‰å…³...')
    s_time = time.time()
    report_list = []

    # ä¸²è¡Œ
    for conf in conf_list:
        logger.debug(f"ğŸ”ƒ èšåˆ{conf.name}çš„{len(conf.strategy_list)}ä¸ªå­ç­–ç•¥ï¼Œå¹¶è®¡ç®—èµ„é‡‘æ›²çº¿...")
        concat_select_results(conf)
        report_list.append(simulate_performance(conf, show_plot=False))

    if len(report_list) > 65535:
        logger.debug(f'å›æµ‹æŠ¥è¡¨æ•°é‡ä¸º {len(report_list)}ï¼Œè¶…è¿‡ 65535ï¼Œåç»­å¯èƒ½ä¼šå ç”¨æµ·é‡å†…å­˜')
    logger.ok(f'å›æµ‹æ¨¡æ‹Ÿå·²å®Œæˆï¼ŒèŠ±è´¹æ—¶é—´ï¼š{time.time() - s_time:.3f}ç§’ï¼Œç´¯è®¡æ—¶é—´ï¼š{(time.time() - r_time):.3f}ç§’')

    return report_list
